<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>伺服器 / 聯賽</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://unpkg.com/vuedraggable@next/dist/vuedraggable.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f8f9fa; padding: 20px; }
  select, button { padding: 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
  button { background-color: #4CAF50; color: white; cursor: pointer; }
  button.mode-btn { background-color: #007bff; margin-left: 10px;}
  button:hover { opacity: 0.9; }
  .flex-row { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap;}
  .box { background:#fff; border: 1px solid #ddd; padding:10px; min-width:200px; min-height:150px; flex:1; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 5px;}
  .box h3 { margin-top:0; padding:5px; border-bottom: 1px solid #eee; font-size:16px; }
  .srv-item { background:#eee; padding:6px; margin:5px 0; cursor:grab; border-radius: 4px;}
  .srv-item.friend { background-color: #d2f7d2 !important; }
  .srv-item.enemy { background-color: #f7d2d2 !important; }
  table { border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-top: 20px; min-width: 300px; border-radius: 5px; overflow:hidden;}
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; font-size: 14px; }
  th { background-color: #343a40; color: white; }
  tr.friend td { background-color: #e6ffe6; }
  tr.enemy td { background-color: #ffe6e6; }
  tr:nth-child(even) { background-color: #f9f9f9; }
</style>
</head>
<body>
<div id="app">

  <!-- 控制列 -->
  <div style="margin-bottom:10px;">
    <label for="srvSelect">選擇伺服器 / 聯賽：</label>
    <select id="srvSelect" v-model="selectedServerOrLeague">
      <option value="">--請選擇--</option>
      <option v-for="srv in serverNames" :key="'srv_' + srv" :value="srv">{{ srv }}</option>
      <option disabled>──────────</option>
      <option v-for="league in leagueNames" :key="'league_' + league" :value="league">{{ league }}（聯賽）</option>
    </select>
    <button class="mode-btn" @click="toggleMode">顯示模式：{{ displayMode === 'single' ? '一起顯示' : '分開顯示' }}</button>
  </div>

  <!-- 拖拉分組區 (支援手機拖拉/滑鼠拖拉) -->
  <div v-if="isLeagueSelected" class="flex-row">
    <div class="box">
      <h3>未分配伺服器</h3>
      <draggable v-model="unassignedServers" group="servers" item-key="srv" :animation="150">
        <template #item="{ element }">
          <div class="srv-item">{{ element }}</div>
        </template>
      </draggable>
    </div>
    <div class="box">
      <h3 style="color:green;">友軍陣營（總戰力：{{ totalExp(friendServers).toLocaleString() }})</h3>
      <draggable v-model="friendServers" group="servers" item-key="srv" :animation="150">
        <template #item="{ element }">
          <div class="srv-item friend">{{ element }}</div>
        </template>
      </draggable>
    </div>
    <div class="box">
      <h3 style="color:red;">敵軍陣營（總戰力：{{ totalExp(enemyServers).toLocaleString() }})</h3>
      <draggable v-model="enemyServers" group="servers" item-key="srv" :animation="150">
        <template #item="{ element }">
          <div class="srv-item enemy">{{ element }}</div>
        </template>
      </draggable>
    </div>
  </div>

  <!-- 顯示模式 -->
  <div v-if="filteredRanking.length">
    <template v-if="displayMode === 'single'">
      <!-- 一起顯示 -->
      <table>
        <thead>
          <tr>
            <th>排名</th>
            <th>角色名稱</th>
            <th>等級</th>
            <th>經驗值</th>
            <th>公會</th>
            <th>伺服器</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, index) in filteredRanking" :key="item.gcid" :class="rowClass(item)">
            <td>{{ index+1 }}</td>
            <td>{{ item.gc_name }}</td>
            <td>{{ item.gc_level }}</td>
            <td>{{ item.gc_exp.toLocaleString() }}</td>
            <td>{{ item.guild_name }}</td>
            <td>{{ translateWorld(item.world_id) }}</td>
          </tr>
        </tbody>
      </table>
    </template>
    <template v-else>
      <!-- 分開顯示 -->
      <div class="flex-row">
        <div style="flex:1;">
          <h3 style="color:green;">友軍排行榜</h3>
          <table>
            <thead><tr><th>排名</th><th>角色名稱</th><th>等級</th><th>經驗值</th><th>公會</th><th>伺服器</th></tr></thead>
            <tbody>
              <tr v-for="(item, index) in friendRanking" :key="'f_'+item.gcid" class="friend">
                <td>{{ index+1 }}</td>
                <td>{{ item.gc_name }}</td>
                <td>{{ item.gc_level }}</td>
                <td>{{ item.gc_exp.toLocaleString() }}</td>
                <td>{{ item.guild_name }}</td>
                <td>{{ translateWorld(item.world_id) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="flex:1;">
          <h3 style="color:red;">敵軍排行榜</h3>
          <table>
            <thead><tr><th>排名</th><th>角色名稱</th><th>等級</th><th>經驗值</th><th>公會</th><th>伺服器</th></tr></thead>
            <tbody>
              <tr v-for="(item, index) in enemyRanking" :key="'e_'+item.gcid" class="enemy">
                <td>{{ index+1 }}</td>
                <td>{{ item.gc_name }}</td>
                <td>{{ item.gc_level }}</td>
                <td>{{ item.gc_exp.toLocaleString() }}</td>
                <td>{{ item.guild_name }}</td>
                <td>{{ translateWorld(item.world_id) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </template>
  </div>
  <p v-else>請選擇伺服器或聯賽以查看戰力名單。</p>
</div>

<script>
const { createApp } = Vue;
const app = createApp({
  components: {
    draggable: vuedraggable
  },
  data() {
    return {
      jsonList: [],
      serverNames: [],
      selectedServerOrLeague: "",
      displayMode: "single",
      worldMap: {
        "키키": "奇奇",
        "레나": "莉娜",
        "아니카": "阿妮卡",
        "루카스": "盧卡斯",
        "휴고": "雨果",
        "아델": "阿戴爾",
        "에다": "艾達",
        "비르바": "維勒巴"
      },
      leagueGroups: {
        "聯賽3": ["雨果3","盧卡斯1","盧卡斯4","盧卡斯5","艾達1","艾達5","維勒巴3","維勒巴5"],
        "聯賽1": ["雨果2","奇奇1","莉娜5","阿妮卡5","阿戴爾3","阿妮卡4","阿妮卡2","維勒巴4"],
        "聯賽2": ["艾達2","艾達3","奇奇4","奇奇5","阿妮卡1","阿妮卡3","奇奇2","艾達4"],
        "聯賽4": ["奇奇3","阿戴爾5","阿戴爾2","盧卡斯3","盧卡斯2","維勒巴1","雨果5","雨果4"],
        "聯賽5": ["阿戴爾1","莉娜4","雨果1","莉娜3","莉娜2","維勒巴2","莉娜1","阿戴爾4"]
      },
      friendServers: [],
      enemyServers: [],
      unassignedServers: []
    };
  },
  computed: {
    leagueNames() {
      return Object.keys(this.leagueGroups);
    },
    isLeagueSelected() {
      return this.leagueGroups[this.selectedServerOrLeague] !== undefined;
    },
    filteredRanking() {
      if (!this.selectedServerOrLeague) return [];
      let targets = this.isLeagueSelected ? this.leagueGroups[this.selectedServerOrLeague] : [this.selectedServerOrLeague];
      return this.jsonList.filter(item => targets.includes(this.translateWorld(item.world_id))).sort((a,b) => b.gc_exp - a.gc_exp);
    },
    friendRanking() {
      return this.jsonList.filter(item => this.friendServers.includes(this.translateWorld(item.world_id))).sort((a,b) => b.gc_exp - a.gc_exp);
    },
    enemyRanking() {
      return this.jsonList.filter(item => this.enemyServers.includes(this.translateWorld(item.world_id))).sort((a,b) => b.gc_exp - a.gc_exp);
    }
  },
  methods: {
    async loadJSONFiles() {
      let allData = [];
      for (let i = 1; i <= 8; i++) {
        const url = `https://xianeddie.github.io/RankingHit2/d${i}.json`;
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.ResultData) {
            allData = allData.concat(json.ResultData);
          }
        } catch (err) {
          console.error(`載入 d${i}.json 失敗:`, err);
        }
      }
      this.jsonList = allData;
      this.setServerNames();
    },
    setServerNames() {
      const srvSet = new Set();
      this.jsonList.forEach(item => srvSet.add(this.translateWorld(item.world_id)));
      this.serverNames = Array.from(srvSet).sort();
    },
    translateWorld(worldStr) {
      for (const key in this.worldMap) {
        if (worldStr.startsWith(key)) {
          return worldStr.replace(key, this.worldMap[key]);
        }
      }
      return worldStr;
    },
    toggleMode() {
      this.displayMode = this.displayMode === 'single' ? 'split' : 'single';
    },
    totalExp(serverList) {
      return serverList.reduce((total, srv) => {
        return total + this.jsonList
          .filter(item => this.translateWorld(item.world_id) === srv)
          .reduce((acc, cur) => acc + cur.gc_exp, 0);
      }, 0);
    }
  },
  watch: {
    selectedServerOrLeague(val) {
      this.friendServers = [];
      this.enemyServers = [];
      if (this.isLeagueSelected) {
        this.unassignedServers = [...this.leagueGroups[val]];
      } else {
        this.unassignedServers = [];
      }
    }
  },
  mounted() {
    this.loadJSONFiles();
  }
});
app.mount("#app");
</script>
</body>
</html>
