<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>伺服器戰力排名 + 等級分布</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #4CAF50;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  tr:hover {
    background-color: #ddd;
  }
  .chart-container {
    width: 100%;
    height: 250px; /* 縮小總戰力圖 */
  }
  .server-section {
    background: #fff;
    padding: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .mini-chart {
    width: 100%;
    height: 200px;
  }
</style>
</head>
<body>
<div id="app">
  <h2>伺服器戰力排名（總體EXP）</h2>
  <div class="chart-container">
    <canvas id="totalExpChart"></canvas>
  </div>
  <table v-if="serverStats.length">
    <thead>
      <tr>
        <th>排名</th>
        <th>伺服器</th>
        <th>總戰力 EXP</th>
        <th>玩家數</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(srv, index) in serverStats" :key="srv.name">
        <td>{{ index + 1 }}</td>
        <td>{{ srv.name }}</td>
        <td>{{ srv.totalExp.toLocaleString() }}</td>
        <td>{{ srv.count }}</td>
      </tr>
    </tbody>
  </table>

  <h2>各伺服器等級分布</h2>
  <div v-for="srv in serverStats" :key="srv.name" class="server-section">
    <h3>{{ srv.name }} 等級分布</h3>
    <div class="mini-chart">
      <canvas :id="'levelChart_' + srv.name"></canvas>
    </div>
    <table>
      <thead>
        <tr>
          <th>等級</th>
          <th>人數</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="lvl in srv.levelStats" :key="lvl.level">
          <td>{{ lvl.level }}</td>
          <td>{{ lvl.count }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      jsonList: [],
      serverStats: [],
      worldMap: {
        "키키": "奇奇",
        "레나": "莉娜",
        "아니카": "阿妮卡",
        "루카스": "盧卡斯",
        "휴고": "雨果",
        "아델": "阿戴爾",
        "에다": "艾達",
        "비르바": "維勒巴"
      }
    };
  },
  methods: {
    async loadJSONFiles() {
      let allData = [];
      for (let i = 1; i <= 8; i++) {
        const url = `https://xianeddie.github.io/RankingHit2/d${i}.json`;
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.ResultData) {
            allData = allData.concat(json.ResultData);
          }
        } catch (err) {
          console.error(`載入 d${i}.json 失敗:`, err);
        }
      }
      this.jsonList = allData;
      this.calcServerStats();
      this.drawTotalExpChart();
      this.drawServerLevelCharts();
    },
    translateWorld(worldStr) {
      for (const key in this.worldMap) {
        if (worldStr.startsWith(key)) {
          return worldStr.replace(key, this.worldMap[key]);
        }
      }
      return worldStr;
    },
    calcServerStats() {
      const stats = {};
      this.jsonList.forEach(item => {
        const worldName = this.translateWorld(item.world_id);
        if (!stats[worldName]) {
          stats[worldName] = { totalExp: 0, count: 0, levels: {} };
        }
        stats[worldName].totalExp += item.gc_exp;
        stats[worldName].count += 1;
        if (!stats[worldName].levels[item.gc_level]) {
          stats[worldName].levels[item.gc_level] = 0;
        }
        stats[worldName].levels[item.gc_level] += 1;
      });
      this.serverStats = Object.keys(stats)
        .map(name => ({
          name,
          totalExp: stats[name].totalExp,
          count: stats[name].count,
          levelStats: Object.keys(stats[name].levels).map(l => ({
            level: parseInt(l),
            count: stats[name].levels[l]
          })).sort((a, b) => a.level - b.level)
        }))
        .sort((a, b) => b.totalExp - a.totalExp);
    },
    drawTotalExpChart() {
      new Chart(document.getElementById("totalExpChart"), {
        type: 'bar',
        data: {
          labels: this.serverStats.map(s => s.name),
          datasets: [{
            label: '總戰力 EXP',
            data: this.serverStats.map(s => s.totalExp),
            backgroundColor: 'rgba(75, 192, 192, 0.6)'
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => ctx.raw.toLocaleString()
              }
            }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    },
    drawServerLevelCharts() {
      this.serverStats.forEach(srv => {
        const ctx = document.getElementById(`levelChart_${srv.name}`);
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: srv.levelStats.map(l => l.level),
            datasets: [{
              label: '人數',
              data: srv.levelStats.map(l => l.count),
              backgroundColor: 'rgba(255, 159, 64, 0.6)'
            }]
          },
          options: {
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      });
    }
  },
  mounted() {
    this.loadJSONFiles();
  }
}).mount("#app");
</script>
</body>
</html>
