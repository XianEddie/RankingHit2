<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>角色經驗值排行榜 + 戰力分布</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    padding: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 40px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #4CAF50;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  tr:hover {
    background-color: #ddd;
  }
  canvas {
    background: white;
    padding: 10px;
    box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 40px;
  }
  select {
    padding: 5px;
    margin-bottom: 20px;
  }
</style>
</head>
<body>
<div id="app">
  <h2>角色經驗值排行榜</h2>

  <label>選擇伺服器：
    <select v-model="selectedWorld" @change="updateCharts">
      <option value="">全部</option>
      <option v-for="world in worldList" :key="world" :value="world">{{ world }}</option>
    </select>
  </label>

  <table v-if="filteredData.length > 0">
    <thead>
      <tr>
        <th>排名</th>
        <th>角色名稱</th>
        <th>等級</th>
        <th>經驗值</th>
        <th>公會</th>
        <th>世界</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(item, index) in filteredData" :key="item.gcid">
        <td>{{ index+1 }}</td>
        <td>{{ item.gc_name }}</td>
        <td>{{ item.gc_level }}</td>
        <td>{{ item.gc_exp.toLocaleString() }}</td>
        <td>{{ item.guild_name }}</td>
        <td>{{ translateWorld(item.world_id) }}</td>
      </tr>
    </tbody>
  </table>

  <h2>平均 EXP</h2>
  <canvas id="expChart"></canvas>

  <h2>平均 Level</h2>
  <canvas id="levelChart"></canvas>

  <h2>總戰力 EXP</h2>
  <canvas id="totalExpChart"></canvas>

</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      jsonList: [],
      selectedWorld: "",
      worldMap: {
        "키키": "奇奇",
        "레나": "莉娜",
        "아니카": "阿妮卡",
        "루카스": "盧卡斯",
        "휴고": "雨果",
        "아델": "阿戴爾",
        "에다": "艾達",
        "비르바": "維勒巴"
      },
      charts: {}
    };
  },
  computed: {
    worldList() {
      const worlds = this.jsonList.map(item => this.translateWorld(item.world_id));
      return [...new Set(worlds)].sort();
    },
    filteredData() {
      let data = [...this.jsonList];
      if (this.selectedWorld) {
        data = data.filter(item => this.translateWorld(item.world_id) === this.selectedWorld);
      }
      return data.sort((a, b) => b.gc_exp - a.gc_exp);
    }
  },
  methods: {
    async loadJSONFiles() {
      let allData = [];
      for (let i = 1; i <= 8; i++) {
        const url = `https://xianeddie.github.io/RankingHit2/d${i}.json`;
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.ResultData) {
            allData = allData.concat(json.ResultData);
          }
        } catch (err) {
          console.error(`載入 d${i}.json 失敗:`, err);
        }
      }
      this.jsonList = allData;
      this.updateCharts();
    },
    translateWorld(worldStr) {
      for (const key in this.worldMap) {
        if (worldStr.startsWith(key)) {
          return worldStr.replace(key, this.worldMap[key]);
        }
      }
      return worldStr;
    },
    updateCharts() {
      // 清除舊圖
      ['expChart', 'levelChart', 'totalExpChart'].forEach(id => {
        if (this.charts[id]) {
          this.charts[id].destroy();
        }
      });

      // 統計
      const stats = {};
      this.filteredData.forEach(item => {
        const worldName = this.translateWorld(item.world_id);
        if (!stats[worldName]) {
          stats[worldName] = { expSum: 0, levelSum: 0, count: 0 };
        }
        stats[worldName].expSum += item.gc_exp;
        stats[worldName].levelSum += item.gc_level;
        stats[worldName].count += 1;
      });

      const labels = Object.keys(stats);
      const avgExp = labels.map(w => Math.round(stats[w].expSum / stats[w].count));
      const avgLevel = labels.map(w => Math.round(stats[w].levelSum / stats[w].count));
      const totalExp = labels.map(w => stats[w].expSum);

      // 畫圖
      this.charts['expChart'] = new Chart(document.getElementById("expChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '平均 EXP', data: avgExp, backgroundColor: 'rgba(75, 192, 192, 0.6)' }]
        },
        options: { responsive: true, plugins: { tooltip: { callbacks: { label: ctx => ctx.raw.toLocaleString() } } } }
      });

      this.charts['levelChart'] = new Chart(document.getElementById("levelChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '平均 Level', data: avgLevel, backgroundColor: 'rgba(255, 159, 64, 0.6)' }]
        },
        options: { responsive: true }
      });

      this.charts['totalExpChart'] = new Chart(document.getElementById("totalExpChart"), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '總戰力 EXP', data: totalExp, backgroundColor: 'rgba(153, 102, 255, 0.6)' }]
        },
        options: { responsive: true, plugins: { tooltip: { callbacks: { label: ctx => ctx.raw.toLocaleString() } } }, scales: { y: { beginAtZero: true } } }
      });
    }
  },
  mounted() {
    this.loadJSONFiles();
  }
}).mount("#app");
</script>
</body>
</html>
