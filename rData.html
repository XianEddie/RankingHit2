<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>角色排行榜 + 伺服器戰力 + 等級分布矩陣</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
  table { border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; min-width: 300px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; font-size: 14px; }
  th { background-color: #4CAF50; color: white; position: sticky; top: 0; }
  tr:nth-child(even) { background-color: #f9f9f9; }
  .scroll-table { overflow-x: auto; }
  .heatmap { background-color: #f0f0f0; }
  .top-grid { display: flex; flex-wrap: wrap; gap: 20px; }
  .grid-item { flex: 1; min-width: 300px; background: #fff; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  @media (max-width: 768px) {
    body { padding: 10px; }
    th, td { font-size: 12px; padding: 4px; }
    .grid-item { min-width: 100%; }
    table { min-width: unset; }
  }
</style>
</head>
<body>
<div id="app">

  <!-- 上方左右兩表 -->
  <div class="top-grid">
    <!-- 左：角色排行榜 -->
    <div class="grid-item">
      <h2>角色經驗值排行榜</h2>
      <table v-if="sortedData.length">
        <thead>
          <tr>
            <th>排名</th>
            <th>角色名稱</th>
            <th>等級</th>
            <th>經驗值</th>
            <th>公會</th>
            <th>世界</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, index) in sortedData" :key="item.gcid">
            <td>{{ index+1 }}</td>
            <td>{{ item.gc_name }}</td>
            <td>{{ item.gc_level }}</td>
            <td>{{ item.gc_exp.toLocaleString() }}</td>
            <td>{{ item.guild_name }}</td>
            <td>{{ translateWorld(item.world_id) }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 右：伺服器戰力總表 -->
    <div class="grid-item">
      <h2>伺服器戰力排名（總體EXP）</h2>
      <table v-if="serverStats.length">
        <thead>
          <tr><th>排名</th><th>伺服器</th><th>總戰力 EXP</th><th>玩家數</th></tr>
        </thead>
        <tbody>
          <tr v-for="(srv, index) in serverStats" :key="srv.name">
            <td>{{ index + 1 }}</td>
            <td>{{ srv.name }}</td>
            <td>{{ srv.totalExp.toLocaleString() }}</td>
            <td>{{ srv.count }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 底部：等級 × 伺服器 分布矩陣 -->
  <h2>等級 × 伺服器 人數分布</h2>
  <div class="scroll-table">
    <table v-if="levelMatrix.length">
      <thead>
        <tr>
          <th>等級 \ 伺服器</th>
          <th v-for="srv in serverNames" :key="'srv_' + srv">{{ srv }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="lvl in allLevels" :key="'lvl_' + lvl">
          <th>Lv{{ lvl }}</th>
          <td v-for="srv in serverNames" :key="srv + '_' + lvl" :style="heatStyle(levelCounts[srv]?.[lvl] || 0)">
            {{ levelCounts[srv]?.[lvl] || 0 }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      jsonList: [],
      serverStats: [],
      serverNames: [],
      levelCounts: {},
      allLevels: [],
      maxCount: 0,
      worldMap: {
        "키키": "奇奇",
        "레나": "莉娜",
        "아니카": "阿妮卡",
        "루카스": "盧卡斯",
        "휴고": "雨果",
        "아델": "阿戴爾",
        "에다": "艾達",
        "비르바": "維勒巴"
      }
    };
  },
  computed: {
    sortedData() {
      return [...this.jsonList].sort((a, b) => b.gc_exp - a.gc_exp);
    },
    levelMatrix() {
      return this.allLevels.map(lvl => {
        const row = { level: lvl };
        this.serverNames.forEach(srv => {
          row[srv] = this.levelCounts[srv]?.[lvl] || 0;
        });
        return row;
      });
    }
  },
  methods: {
    async loadJSONFiles() {
      let allData = [];
      for (let i = 1; i <= 8; i++) {
        const url = `https://xianeddie.github.io/RankingHit2/d${i}.json`;
        try {
          const res = await fetch(url);
          const json = await res.json();
          if (json.ResultData) {
            allData = allData.concat(json.ResultData);
          }
        } catch (err) {
          console.error(`載入 d${i}.json 失敗:`, err);
        }
      }
      this.jsonList = allData;
      this.calcServerStats();
      this.calcLevelMatrix();
    },
    translateWorld(worldStr) {
      for (const key in this.worldMap) {
        if (worldStr.startsWith(key)) {
          return worldStr.replace(key, this.worldMap[key]);
        }
      }
      return worldStr;
    },
    calcServerStats() {
      const stats = {};
      this.jsonList.forEach(item => {
        const worldName = this.translateWorld(item.world_id);
        if (!stats[worldName]) {
          stats[worldName] = { totalExp: 0, count: 0 };
        }
        stats[worldName].totalExp += item.gc_exp;
        stats[worldName].count += 1;
      });
      this.serverStats = Object.keys(stats)
        .map(name => ({
          name,
          totalExp: stats[name].totalExp,
          count: stats[name].count
        }))
        .sort((a, b) => b.totalExp - a.totalExp);
      this.serverNames = this.serverStats.map(s => s.name);
    },
    calcLevelMatrix() {
      const lvlSet = new Set();
      const lvlCounts = {};

      this.jsonList.forEach(item => {
        const srv = this.translateWorld(item.world_id);
        const lvl = item.gc_level;
        lvlSet.add(lvl);

        if (!lvlCounts[srv]) {
          lvlCounts[srv] = {};
        }
        if (!lvlCounts[srv][lvl]) {
          lvlCounts[srv][lvl] = 0;
        }
        lvlCounts[srv][lvl] += 1;

        if (lvlCounts[srv][lvl] > this.maxCount) {
          this.maxCount = lvlCounts[srv][lvl];
        }
      });

      this.allLevels = Array.from(lvlSet).sort((a, b) => a - b);
      this.levelCounts = lvlCounts;
    },
    heatStyle(count) {
      if (count === 0) return {};
      const intensity = count / this.maxCount;
      const colorVal = Math.floor(255 - intensity * 150); 
      return { backgroundColor: `rgb(${colorVal}, ${255-colorVal/2}, ${colorVal})` };
    }
  },
  mounted() {
    this.loadJSONFiles();
  }
}).mount("#app");
</script>
</body>
</html>
